# CLI Commands

> The `@nuxfly/cli` provides powerful commands for deploying and managing your Nuxt applications on Fly.io.

## Installation

:pm-install{name="@nuxfly/cli" dev=false global=true}

## Authentication

Before using the CLI, make sure you're authenticated with Fly.io:

```bash
fly auth login
```

## Commands Overview

The CLI provides several commands for different stages of your deployment workflow:

::card-group
  ::card
  ---
  title: 'launch'
  icon: 'i-heroicons-rocket-launch'
  ---
  Create and configure a new Fly.io application with database and storage
  ::
  ::card
  ---
  title: 'deploy'
  icon: 'i-heroicons-cloud-arrow-up'
  ---
  Deploy your application to Fly.io with automatic bucket creation
  ::
  ::card
  ---
  title: 'generate'
  icon: 'i-heroicons-document-plus'
  ---
  Generate deployment files (Dockerfile, fly.toml) without deploying
  ::
  ::card
  ---
  title: 'studio'
  icon: 'i-heroicons-wrench-screwdriver'
  ---
  Open Drizzle Studio with secure tunnel to your database
  ::
::

## Global Options

All commands support these global options:

- `--verbose, -v` - Enable verbose logging
- `--config` - Path to fly.toml config file
- `--app, -a` - Fly app name

## `launch`

Create a new Fly.io application with integrated database and storage.

```bash
nuxfly launch [options]
```

### Options

- `--name` - App name (if not provided, Fly.io will generate one)
- `--region` - Region to deploy to (e.g., `ord`, `fra`, `nrt`)
- `--no-deploy` - Skip deployment after launch (default: true)
- `--size` - Size in GB for SQLite volume (default: 1)

### Multi-Environment Support

Creates environment-specific configuration files based on `NUXFLY_ENV`:
- `NUXFLY_ENV=prod` (or unset) → Creates `fly.toml`
- `NUXFLY_ENV=staging` → Creates `fly.staging.toml`
- `NUXFLY_ENV=development` → Creates `fly.development.toml`

### What it does

1. **Creates Fly.io App** - Initializes a new application on Fly.io
2. **Sets up SQLite Database** - Creates a persistent volume for SQLite with Litestream backup
3. **Configures S3 Storage** - Creates public and private S3-compatible buckets
4. **Generates Files** - Creates Dockerfile and environment-specific fly.toml in `.nuxfly/` directory
5. **Sets Environment Variables** - Configures database and storage credentials

### Example

```bash
# Launch production app (creates fly.toml)
nuxfly launch --name my-nuxt-app --region ord

# Launch staging app (creates fly.staging.toml)
export NUXFLY_ENV=staging
nuxfly launch --name my-app-staging --region ord

# Launch with larger database volume
nuxfly launch --size 5
```

::tip
The launch command creates a `.nuxfly/` directory in your project with all deployment files. This keeps your project root clean while maintaining all necessary configuration.
::

## `deploy`

Deploy your application to Fly.io with automatic infrastructure setup.

```bash
nuxfly deploy [options]
```

### Options

- `--strategy` - Deployment strategy (e.g., `rolling`, `immediate`)
- `--build` - Build the application before deploying (default: false)

### Multi-Environment Support

Uses the appropriate configuration file based on `NUXFLY_ENV`:
- If only `fly.toml` exists: Uses `fly.toml` (no `NUXFLY_ENV` required)
- If `fly.*.toml` files exist: Requires `NUXFLY_ENV` to select the correct file

### What it does

1. **Validates Configuration** - Ensures all required files and settings are present
2. **Creates Missing Buckets** - Automatically creates any missing S3 buckets
3. **Builds Application** - Optionally builds your Nuxt app before deployment
4. **Deploys to Fly.io** - Pushes your application using the environment-specific configuration

### Example

```bash
# Deploy to production (if only fly.toml exists)
nuxfly deploy

# Deploy to specific environment (when multiple fly.*.toml files exist)
NUXFLY_ENV=staging nuxfly deploy --build
NUXFLY_ENV=prod nuxfly deploy --strategy rolling
```

## `generate`

Generate deployment files without deploying.

```bash
nuxfly generate [options]
```

### Options

- `--build` - Build the application before generating files (default: false)

### What it does

1. **Creates Dockerfile** - Generates optimized Dockerfile for Nuxt applications
2. **Creates fly.toml** - Generates Fly.io configuration with proper settings
3. **Sets up Environment** - Configures environment variables for database and storage

### Generated Files

The command creates these files in the `.nuxfly/` directory:

- `Dockerfile` - Multi-stage Docker build for optimal image size
- `fly.toml` - Fly.io application configuration
- `.dockerignore` - Docker ignore patterns

### Example

```bash
# Generate files only
nuxfly generate

# Generate with build step
nuxfly generate --build
```

## `studio`

Open Drizzle Studio with secure tunnel to your production database.

```bash
nuxfly studio [options]
```

### Options

- `--port` - Local port for studio (default: 4983)
- `--remote-port` - Remote tunnel port (default: 5432)

### What it does

1. **Creates Secure Tunnel** - Establishes encrypted connection to your database
2. **Launches Drizzle Studio** - Opens the database management interface
3. **Provides Access** - Allows you to browse and edit your production data safely

### Requirements

- `drizzle-kit` must be installed in your project
- Valid `drizzle.config.ts` configuration file
- Deployed application with database

### Example

```bash
# Open studio on default port
nuxfly studio

# Use custom port
nuxfly studio --port 3000

# Custom tunnel configuration
nuxfly studio --port 4000 --remote-port 5433
```

::warning
Be careful when editing production data through Studio. Always backup your database before making significant changes.
::

## `import`

Import existing Fly app configuration.

```bash
nuxfly import [options]
```

### Options

- `--app` - App name to import

### What it does

1. **Downloads Configuration** - Retrieves existing fly.toml from Fly.io
2. **Saves Locally** - Stores configuration in `.nuxfly/fly.toml`
3. **Validates Setup** - Ensures all required settings are present

### Example

```bash
# Import specific app
nuxfly import --app my-existing-app
```

## `proxy`

Proxy unknown commands to flyctl with app context.

The CLI automatically proxies any unrecognized commands to the Fly.io CLI (`flyctl`) with the correct app context.

### Example

```bash
# These commands are proxied to flyctl:
nuxfly logs
nuxfly status
nuxfly ssh console
nuxfly scale show
```

This allows you to use any flyctl command while maintaining the context of your nuxfly-managed application.

## Configuration

### Project Configuration

The CLI looks for configuration in several places:

1. `.nuxfly/fly.toml` - Generated Fly.io configuration
2. `fly.toml` - Standard Fly.io configuration (if present)
3. Environment variables
4. Command-line arguments

### Environment Variables

You can override configuration using environment variables:

```bash
# App configuration
FLY_APP_NAME=my-app
FLY_REGION=ord

# Database
NUXFLY_DB_URL=file:.data/db.sqlite

# Storage
NUXFLY_PUBLIC_BUCKET_NAME=my-public-bucket
NUXFLY_PRIVATE_BUCKET_NAME=my-private-bucket
```

## Workflow Examples

### Initial Setup

```bash
# 1. Create and configure new app
nuxfly launch --name my-blog --region ord

# 2. Deploy the application
nuxfly deploy --build

# 3. Check status
nuxfly status

# 4. View logs
nuxfly logs
```

### Development Workflow

```bash
# Make changes to your app...

# Deploy updates
nuxfly deploy

# Check database
nuxfly studio

# Monitor logs
nuxfly logs --follow
```

### Database Management

```bash
# Open database studio
nuxfly studio

# SSH into app for direct access
nuxfly ssh console

# Check app status
nuxfly status
```

## Troubleshooting

### Common Issues

::collapsible
---
title: "Command not found: nuxfly"
---
Make sure the CLI is installed globally:
```bash
npm install -g @nuxfly/cli
```
::

::collapsible
---
title: "Not authenticated with Fly.io"
---
Login to Fly.io first:
```bash
fly auth login
```
::

::collapsible
---
title: "App name already exists"
---
Choose a different app name or import the existing app:
```bash
nuxfly import --app existing-app-name
```
::

::collapsible
---
title: "Database connection failed"
---
Check your database configuration and ensure the app is deployed:
```bash
nuxfly status
nuxfly logs
```
::

### Debug Mode

Enable verbose logging for detailed output:

```bash
nuxfly --verbose deploy
```

### Getting Help

Get help for any command:

```bash
nuxfly --help
nuxfly launch --help
nuxfly deploy --help
```

## Advanced Usage

### Custom Dockerfile

You can customize the generated Dockerfile by editing `.nuxfly/Dockerfile` after generation:

```dockerfile
# .nuxfly/Dockerfile
FROM node:18-alpine

# Your custom modifications...
```

### Custom fly.toml

Modify the generated `.nuxfly/fly.toml` for advanced configuration:

```toml
# .nuxfly/fly.toml
[build]
  dockerfile = ".nuxfly/Dockerfile"

[env]
  NODE_ENV = "production"
  # Your custom environment variables...

[[services]]
  internal_port = 3000
  protocol = "tcp"
  # Your custom service configuration...
```

### Multiple Environments

Nuxfly supports multi-environment deployments using `NUXFLY_ENV` and environment-specific configuration files:

**File naming convention:**
- `fly.toml` - Production (default, or when `NUXFLY_ENV=prod`)
- `fly.staging.toml` - Staging (when `NUXFLY_ENV=staging`)
- `fly.development.toml` - Development (when `NUXFLY_ENV=development`)

**When NUXFLY_ENV is required:**
- **Single environment** (only `fly.toml`): `NUXFLY_ENV` is optional (defaults to `prod`)
- **Multi-environment** (has `fly.*.toml` files): `NUXFLY_ENV` is required

**Setup and deploy:**
```bash
# Create staging environment
export NUXFLY_ENV=staging
nuxfly launch myapp-staging --region ord

# Create production environment
export NUXFLY_ENV=prod  # or omit if only fly.toml exists
nuxfly launch myapp-prod --region ord

# Deploy to environments
NUXFLY_ENV=staging nuxfly deploy
NUXFLY_ENV=prod nuxfly deploy  # or just: nuxfly deploy (if there are no other fly.*.toml files)
```

:read-more{to="/guide"}
:read-more{to="/module"}